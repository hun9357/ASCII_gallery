---
import BaseLayout from '../layouts/BaseLayout.astro';
import AsciiCard from '../components/AsciiCard.astro';
import asciiArts from '../data/ascii-arts.json';

const title = "My Favorites - ASCII Art Gallery";
const description = "View and manage your favorite ASCII art. Quick access to your saved text art collection.";
---

<BaseLayout title={title} description={description}>
  <meta slot="head" name="robots" content="noindex, nofollow" />
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-10">
      <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100 mb-4">
        ‚≠ê My Favorites
      </h1>
      <p class="text-lg text-gray-600 dark:text-gray-400">
        Your saved ASCII art collection
      </p>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-16">
      <div class="text-6xl mb-4">üíî</div>
      <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-300 mb-2">
        No favorites yet
      </h2>
      <p class="text-gray-500 dark:text-gray-400 mb-6">
        Start adding ASCII art to your favorites by clicking the heart icon on any art card.
      </p>
      <a
        href="/"
        class="inline-block px-6 py-3 bg-blue-500 text-white font-medium rounded-lg hover:bg-blue-600 transition-colors"
      >
        Browse ASCII Art
      </a>
    </div>

    <!-- Favorites Grid -->
    <div id="favorites-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Will be populated by JavaScript -->
    </div>

    <!-- Clear All Button -->
    <div id="clear-all-container" class="hidden mt-8 text-center">
      <button
        id="clear-all-btn"
        class="px-6 py-3 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500"
      >
        Clear All Favorites
      </button>
    </div>
  </div>
</BaseLayout>

<script>
  import asciiArtsData from '../data/ascii-arts.json';

  const FAVORITES_KEY = 'ascii_favorites';
  const favoritesGrid = document.getElementById('favorites-grid');
  const emptyState = document.getElementById('empty-state');
  const clearAllContainer = document.getElementById('clear-all-container');
  const clearAllBtn = document.getElementById('clear-all-btn');

  function getFavorites(): string[] {
    try {
      const stored = localStorage.getItem(FAVORITES_KEY);
      return stored ? JSON.parse(stored) : [];
    } catch {
      return [];
    }
  }

  function renderFavorites() {
    const favoriteIds = getFavorites();

    if (!favoritesGrid || !emptyState || !clearAllContainer) return;

    if (favoriteIds.length === 0) {
      favoritesGrid.classList.add('hidden');
      clearAllContainer.classList.add('hidden');
      emptyState.classList.remove('hidden');
      return;
    }

    emptyState.classList.add('hidden');
    favoritesGrid.classList.remove('hidden');
    clearAllContainer.classList.remove('hidden');

    // Filter favorite arts from imported data
    const data = asciiArtsData;
    const favoriteArts = data.arts?.filter((art: any) =>
      favoriteIds.includes(art.id)
    ) || [];

    // Helper function to escape HTML to prevent XSS
    function escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    favoritesGrid.innerHTML = favoriteArts.map((art: any) => `
          <div data-searchable="${escapeHtml(art.title)} ${escapeHtml(art.category)} ${escapeHtml(art.tags.join(' '))}">
            <article class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-md transition-shadow">
              <div class="p-4">
                <h3 class="font-medium text-gray-900 dark:text-gray-100 mb-3">
                  <a href="/art/${escapeHtml(art.id)}" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                    ${escapeHtml(art.title)}
                  </a>
                </h3>

                <div class="bg-gray-50 dark:bg-gray-900 rounded-md p-4 mb-4 overflow-x-auto">
                  <pre class="ascii-content text-sm text-gray-800 dark:text-gray-200 select-all">${escapeHtml(art.content)}</pre>
                </div>

                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <a
                      href="/category/${escapeHtml(art.category)}"
                      class="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-full hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors"
                    >
                      ${escapeHtml(art.category)}
                    </a>
                    <button
                      class="favorite-btn p-1 text-red-500 hover:text-red-600 focus:outline-none"
                      data-art-id="${escapeHtml(art.id)}"
                      aria-label="Remove from favorites"
                    >
                      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"></path>
                      </svg>
                    </button>
                  </div>

                  <button
                    class="copy-btn px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-md hover:bg-blue-600 transition-colors cursor-pointer"
                    data-content="${escapeHtml(art.content)}"
                  >
                    Copy
                  </button>
                </div>
              </div>
            </article>
          </div>
    `).join('');

    // Re-attach favorite button listeners
    attachFavoriteListeners();
  }

  function attachFavoriteListeners() {
    const favoriteButtons = favoritesGrid?.querySelectorAll('.favorite-btn');
    favoriteButtons?.forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        const artId = (button as HTMLElement).dataset.artId;
        if (artId) {
          // Remove from favorites
          const favorites = getFavorites();
          const index = favorites.indexOf(artId);
          if (index > -1) {
            favorites.splice(index, 1);
            localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
            window.dispatchEvent(new CustomEvent('favoritesChanged', { detail: { favorites } }));
            renderFavorites();
          }
        }
      });
    });
  }

  function clearAllFavorites() {
    if (confirm('Are you sure you want to remove all favorites?')) {
      localStorage.setItem(FAVORITES_KEY, JSON.stringify([]));
      window.dispatchEvent(new CustomEvent('favoritesChanged', { detail: { favorites: [] } }));
      renderFavorites();
    }
  }

  // Initial render
  renderFavorites();

  // Listen for favorites changes
  window.addEventListener('favoritesChanged', renderFavorites);

  // Clear all button
  clearAllBtn?.addEventListener('click', clearAllFavorites);
</script>
