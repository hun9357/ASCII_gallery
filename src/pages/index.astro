---
import BaseLayout from '../layouts/BaseLayout.astro';
import AsciiCard from '../components/AsciiCard.astro';
import SearchBar from '../components/SearchBar.astro';
import CategoryFilter from '../components/CategoryFilter.astro';
import TagFilter from '../components/TagFilter.astro';
import SkeletonCard from '../components/SkeletonCard.astro';
import asciiArts from '../data/ascii-arts.json';

const title = "ASCII Art Copy Paste - Free Text Art Collection";
const description = "Copy and paste ASCII art instantly. Free collection of text art, symbols, animals, borders, and emojis for Discord, social media, and messaging. One-click copy!";

// Get selected tags from URL query parameters
const selectedTags = Astro.url.searchParams.get('tags')?.split(',').filter(Boolean) || [];

// Filter arts by selected tags (AND logic)
let filteredArts = asciiArts.arts;
if (selectedTags.length > 0) {
  filteredArts = asciiArts.arts.filter(art =>
    selectedTags.every(tag => art.tags.includes(tag))
  );
}

// Get popular arts (those with 'cute', 'simple', or common tags)
const popularTags = ['cute', 'simple', 'kaomoji', 'heart'];
const popularArts = asciiArts.arts
  .filter(art => art.tags.some(tag => popularTags.includes(tag)))
  .slice(0, 8);

// Get new arrivals (last 8 items in the array)
const newArrivals = asciiArts.arts.slice(-8).reverse();

// Initial load: show first 24 items
const initialLoadCount = 24;
const initialArts = filteredArts.slice(0, initialLoadCount);
const hasMore = filteredArts.length > initialLoadCount;

// Create ItemList schema for the homepage
const siteUrl = 'https://asciiartgallery.netlify.app';
const schema = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "name": "ASCII Art Gallery",
      "description": "Free ASCII art copy and paste collection. 200+ text art, kaomoji, emoticons, animals, symbols.",
      "url": siteUrl,
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": `${siteUrl}/?q={search_term_string}`
        },
        "query-input": "required name=search_term_string"
      }
    },
    {
      "@type": "ItemList",
      "name": "ASCII Art Collection",
      "description": "Complete collection of copy-paste ASCII art",
      "numberOfItems": asciiArts.arts.length,
      "itemListElement": asciiArts.arts.slice(0, 20).map((art, index) => ({
        "@type": "ListItem",
        "position": index + 1,
        "item": {
          "@type": "CreativeWork",
          "@id": `${siteUrl}/art/${art.id}`,
          "name": art.title,
          "description": `${art.title} ASCII art - ${art.category}`,
          "text": art.content,
          "genre": "ASCII Art",
          "keywords": art.tags.join(', '),
          "inLanguage": "en",
          "isAccessibleForFree": true
        }
      }))
    }
  ]
};
---

<BaseLayout title={title} description={description} schema={schema}>
  <!-- Hero Section -->
  <section class="text-center mb-10">
    <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100 mb-4">ASCII Art Gallery</h1>
    <p class="text-lg text-gray-600 dark:text-gray-400 mb-6">Copy & paste ASCII art instantly. Free collection for Discord, social media, and messaging.</p>

    <div class="max-w-xl mx-auto">
      <SearchBar placeholder="Search ASCII art (cat, heart, shrug...)" />
    </div>
  </section>

  <!-- Category Filter -->
  <CategoryFilter />

  <!-- Tag Filter -->
  <TagFilter selectedTags={selectedTags} />

  <!-- Popular ASCII Art Section -->
  {!selectedTags.length && (
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Popular ASCII Art</h2>
        <a href="/?tags=cute" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 text-sm font-medium transition-colors">
          View All →
        </a>
      </div>
      <div class="overflow-x-auto pb-4 -mx-4 px-4">
        <div class="flex gap-4" style="min-width: min-content;">
          {popularArts.map((art) => (
            <div class="flex-none w-72">
              <AsciiCard
                id={art.id}
                title={art.title}
                content={art.content}
                category={art.category}
                tags={art.tags}
              />
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- New Arrivals Section -->
  {!selectedTags.length && (
    <section class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">New Arrivals</h2>
        <a href="/" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 text-sm font-medium transition-colors">
          Browse All →
        </a>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {newArrivals.slice(0, 4).map((art) => (
          <AsciiCard
            id={art.id}
            title={art.title}
            content={art.content}
            category={art.category}
            tags={art.tags}
          />
        ))}
      </div>
    </section>
  )}

  <!-- Ad Slot Placeholder -->
  <div class="bg-gray-100 dark:bg-gray-800 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 mb-8 text-center text-gray-400 dark:text-gray-500 text-sm">
    Ad Space (728x90)
  </div>

  <!-- All ASCII Art Section -->
  {selectedTags.length > 0 && <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">Filtered Results</h2>}
  {!selectedTags.length && <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">All ASCII Art</h2>}

  <!-- Results count and empty state -->
  <div class="mb-4">
    <p class="text-gray-600 dark:text-gray-400 text-sm">
      <span id="results-count" class="font-medium">{filteredArts.length}</span> results found
    </p>
  </div>

  <!-- Empty state container -->
  <div id="no-results-message"></div>

  <!-- ASCII Art Grid -->
  <div id="art-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {initialArts.map((art) => (
      <div class="art-card" data-searchable={`${art.title} ${art.category} ${art.tags.join(' ')}`}>
        <AsciiCard
          id={art.id}
          title={art.title}
          content={art.content}
          category={art.category}
          tags={art.tags}
        />
      </div>
    ))}
  </div>

  <!-- Loading indicator -->
  {hasMore && (
    <div id="loading-indicator" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
      {Array.from({ length: 3 }).map(() => (
        <SkeletonCard />
      ))}
    </div>
  )}

  <!-- Sentinel element for intersection observer -->
  {hasMore && <div id="load-more-sentinel" class="h-10"></div>}

  <!-- Ad Slot Placeholder -->
  <div class="bg-gray-100 dark:bg-gray-800 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 mt-8 text-center text-gray-400 dark:text-gray-500 text-sm">
    Ad Space (728x90)
  </div>

  <!-- SEO Content -->
  <section class="mt-12 prose prose-gray dark:prose-invert max-w-none">
    <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-4">What is ASCII Art?</h2>
    <p class="text-gray-600 dark:text-gray-400 mb-4">
      ASCII art is a graphic design technique that uses text characters to create visual art.
      These text-based images can be easily copied and pasted into any platform that supports text,
      including Discord, Twitter, Instagram bios, messaging apps, and code comments.
    </p>

    <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-4 mt-8">How to Use ASCII Art</h2>
    <ol class="list-decimal list-inside text-gray-600 dark:text-gray-400 space-y-2">
      <li>Browse our collection or use the search bar to find ASCII art you like</li>
      <li>Click the "Copy" button to copy the ASCII art to your clipboard</li>
      <li>Paste it anywhere using Ctrl+V (Windows) or Cmd+V (Mac)</li>
    </ol>

    <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-4 mt-8">Popular ASCII Art Categories</h2>
    <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 space-y-2">
      <li><strong>Animals</strong> - Cats, dogs, bunnies, and more cute creatures</li>
      <li><strong>Symbols</strong> - Hearts, stars, arrows, and special characters</li>
      <li><strong>Emoticons</strong> - Kaomoji and text faces like shrug and lenny face</li>
      <li><strong>Borders</strong> - Decorative frames and dividers for messages</li>
      <li><strong>Text Art</strong> - Banners, objects, and creative designs</li>
    </ul>
  </section>
</BaseLayout>

<script define:vars={{ filteredArts, initialLoadCount }}>
  // Lazy loading with Intersection Observer
  let currentLoadedCount = initialLoadCount;
  const loadMoreCount = 12;
  const artGrid = document.getElementById('art-grid');
  const loadingIndicator = document.getElementById('loading-indicator');
  const sentinel = document.getElementById('load-more-sentinel');

  if (sentinel && artGrid) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && currentLoadedCount < filteredArts.length) {
            // Show loading indicator
            if (loadingIndicator) {
              loadingIndicator.style.display = 'grid';
            }

            // Simulate loading delay for better UX
            setTimeout(() => {
              const nextArts = filteredArts.slice(
                currentLoadedCount,
                currentLoadedCount + loadMoreCount
              );

              nextArts.forEach((art) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'art-card';
                cardDiv.setAttribute('data-searchable', `${art.title} ${art.category} ${art.tags.join(' ')}`);

                // Create the card HTML
                cardDiv.innerHTML = `
                  <article class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-md transition-shadow">
                    <div class="p-4">
                      <div class="flex items-start justify-between mb-3">
                        <h3 class="font-medium text-gray-900 dark:text-gray-100 flex-1">
                          <a href="/art/${art.id}" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                            ${art.title}
                          </a>
                        </h3>
                        <button class="favorite-btn w-8 h-8 rounded-full flex items-center justify-center transition-colors hover:bg-gray-100 dark:hover:bg-gray-700" data-art-id="${art.id}" aria-label="Add to favorites">
                          <svg class="w-5 h-5 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                          </svg>
                        </button>
                      </div>
                      <div class="bg-gray-50 dark:bg-gray-900 rounded-md p-4 mb-4 overflow-x-auto">
                        <pre class="ascii-content text-sm text-gray-800 dark:text-gray-200 select-all">${art.content}</pre>
                      </div>
                      <div class="flex items-center justify-between">
                        <div class="flex flex-wrap gap-1">
                          <a href="/category/${art.category}" class="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-full hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
                            ${art.category}
                          </a>
                        </div>
                        <button class="copy-btn px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-md hover:bg-blue-600 transition-colors cursor-pointer" data-content="${art.content.replace(/"/g, '&quot;')}">
                          Copy
                        </button>
                      </div>
                    </div>
                  </article>
                `;

                artGrid.appendChild(cardDiv);
              });

              currentLoadedCount += nextArts.length;

              // Hide loading indicator
              if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
              }

              // Remove sentinel if all loaded
              if (currentLoadedCount >= filteredArts.length && sentinel) {
                sentinel.remove();
                observer.disconnect();
              }

              // Re-initialize copy and favorite buttons for new cards
              initializeCopyButtons();
              initializeFavoriteButtons();

              // Update search results to include newly loaded cards
              if (typeof (window as any).updateSearchResults === 'function') {
                const searchInput = document.getElementById('search-input') as HTMLInputElement;
                if (searchInput) {
                  (window as any).updateSearchResults(searchInput.value.toLowerCase().trim());
                }
              }
            }, 300);
          }
        });
      },
      {
        rootMargin: '100px',
      }
    );

    observer.observe(sentinel);
  }

  // Initialize copy buttons (from existing script)
  function initializeCopyButtons() {
    document.querySelectorAll('.copy-btn').forEach((btn) => {
      const newBtn = btn.cloneNode(true);
      btn.replaceWith(newBtn);

      newBtn.addEventListener('click', async () => {
        const content = newBtn.getAttribute('data-content');
        if (!content) return;

        try {
          await navigator.clipboard.writeText(content);
          const originalText = newBtn.textContent;
          newBtn.textContent = 'Copied!';
          newBtn.classList.add('bg-green-500', 'hover:bg-green-600');
          newBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');

          setTimeout(() => {
            newBtn.textContent = originalText;
            newBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            newBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    });
  }

  // Initialize favorite buttons (from existing script)
  function initializeFavoriteButtons() {
    document.querySelectorAll('.favorite-btn').forEach((btn) => {
      const artId = btn.getAttribute('data-art-id');
      if (!artId) return;

      const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      const isFavorite = favorites.includes(artId);

      const svg = btn.querySelector('svg');
      if (svg) {
        if (isFavorite) {
          svg.setAttribute('fill', 'currentColor');
          svg.classList.add('text-red-500');
        } else {
          svg.setAttribute('fill', 'none');
          svg.classList.remove('text-red-500');
        }
      }

      const newBtn = btn.cloneNode(true);
      btn.replaceWith(newBtn);

      newBtn.addEventListener('click', () => {
        const currentFavorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        const index = currentFavorites.indexOf(artId);
        const newSvg = newBtn.querySelector('svg');

        if (index > -1) {
          currentFavorites.splice(index, 1);
          if (newSvg) {
            newSvg.setAttribute('fill', 'none');
            newSvg.classList.remove('text-red-500');
          }
        } else {
          currentFavorites.push(artId);
          if (newSvg) {
            newSvg.setAttribute('fill', 'currentColor');
            newSvg.classList.add('text-red-500');
          }
        }

        localStorage.setItem('favorites', JSON.stringify(currentFavorites));
      });
    });
  }

  // Initial setup
  initializeCopyButtons();
  initializeFavoriteButtons();
</script>
